# Analyse


```{r, setup_analysis, echo=FALSE, warning=FALSE, message=FALSE}

suppressPackageStartupMessages({
  library(dplyr)
  library(stringr)
  library(purrr)
  library(pbmcapply)
})

source("R/03-analysis.R")

# TODO: remove
quotes_line <- readRDS("tmp/quotes_line.rds")

```

Für die Analyse der Daten mit dem Ziel einen Kaufs- sowie einen Verkaufkurs zu prognostizieren, bei dem der Delta-Hedge nachgezogen werden soll, werden nachfolgend verschiedene Techniken eingesetzt. Diese sind:

- Einfache Optimierungen
- KLassifikationsverfahren (bsp. KNN):
- Neuronale Netzwerke (bsp. RNN, LTSM):
- Autogressive Modelle (bsp. GARCH)


## Einfache Optimierungen

Eine einfache Möglichkeit, optimale Kaufs- und Verkaufspreise zu finden besteht darin, diese im Testdatensatz mittels einfacher Optimierung zu evaluieren. In einer ersten sehr einfachen Evaluation bietet es sich an, die Kaufs- und Verkaufsmarken als optimierte prozentuale Bewegungen vom aktuellen Preis zu ermitteln. Dies lässt sich sowohl symmetrische wie auch asymmetrisch machen. 

```{r, echo=FALSE}

opt_payoff_sym <- function(move, quotes_line) {
  sum(calc_payoff_const_gamma(quotes_line, buy = (1 - move) * quotes_line$Adjusted_t_1, sell = (1 + move) * quotes_line$Adjusted_t_1))
}

sum(calc_payoff_const_gamma(quotes_line, buy = quotes_line$Low, sell = quotes_line$High)) / sum(calc_payoff_const_gamma(quotes_line))
sum(calc_payoff_const_gamma(quotes_line, buy = quotes_line$Low, sell = quotes_line$High, both_first = "min")) / sum(calc_payoff_const_gamma(quotes_line))


move <- seq(0, 1, 0.005)
factor <- unlist(pbmclapply(move,  opt_payoff_sym, quotes_line = quotes_line, mc.cores = 1))/sum(calc_payoff_const_gamma(quotes_line))
res <- tibble(move = move, factor = factor)

plot(res$move, res$factor, type = "l")

a <- calc_payoff_const_gamma(quotes_line)

move <- 0.995
b <- calc_payoff_const_gamma(quotes_line, buy = (1 - move) * quotes_line$Adjusted_t_1, sell = (1 + move) * quotes_line$Adjusted_t_1)

a < b
quotes_line[a < b, ]
(a-b)[a > b]

cbind(quotes_line[a > b, ], (a-b)[a > b])


quotes_line[which((a-b) > 1930), ]



res

# why the sudden decrease
res <- tibble(move = seq(0, 1, 0.005), factor = unlist(res) / sum(calc_payoff_const_gamma(quotes_line)))
plot(res$move, res$factor, type = "l")

move_max <- res$move[which.max(res$factor)]
payoff_max <- calc_payoff_const_gamma(quotes_line, buy = (1 - move_max) * quotes_line$Adjusted_t_1, sell = (1 + move_max) * quotes_line$Adjusted_t_1)

move_after_max <- res$move[which.max(res$factor) + 1]
payoff_after_max <- calc_payoff_const_gamma(quotes_line, buy = (1 - move_after_max) * quotes_line$Adjusted_t_1, sell = (1 + move_after_max) * quotes_line$Adjusted_t_1)

sum(payoff_max)
sum(payoff_after_max)

summary(payoff_max - payoff_after_max)

which.max(payoff_max - payoff_after_max)

quotes_line[which.max(payoff_max - payoff_after_max), ]

371445.1/422361.2

```


## Klassifikationsverfahren


```{r, echo=FALSE}

```

## Neuronale Netzwerke

## Autoregressive Modelle
