# Analyse


```{r message=FALSE, warning=FALSE, setup_analysis, echo=FALSE}
suppressPackageStartupMessages({
  library(dplyr)
  library(stringr)
  library(purrr)
  library(pbmcapply)
  library(tidyr)
  library(ggplot2)
  library(data.table)
  library(dtplyr)
  library(arrow)
  library(microbenchmark)
  library(profvis)
  library(dqrng)
  library(keras)
  library(magrittr)
  library(gglorenz)
})

source("R/02-data.R")
source("R/03-analysis.R")

Rcpp::sourceCpp('src/bootstrap_nn_idx.cpp')
Rcpp::sourceCpp('src/calc_payoff_per_title.cpp')
Rcpp::sourceCpp('src/drop_late_nn_idx.cpp')

```





```{r, knn-data-preparation, echo=FALSE}

quotes_clean <- arrow::read_feather(paste0("data/quotes_clean.feather"))
window <- 3
data_wide_3_all <- quotes_clean %>%
  dplyr::group_by(Ticker) %>%
  dplyr::group_modify(~widen(., window = window + 1, cols = c("Close", "Open", "Low", "High"), keep = c("Date", "Close", "Open", "Low", "High"))) %>%
  dplyr::ungroup() %>%
  dplyr::rename(Close_0 = "Close", Open_0 = "Open", Low_0 = "Low", High_0 = "High") %>%
  normalize_quotes("Close_1", setdiff(names(.), c("Ticker", "Date")))

# remove unneeded (after normalization) day before window start
data_wide_3 <- dplyr::select(data_wide_3_all, c("Ticker", "Date", str_subset(names(data_wide_3_all), paste0("_[^", window + 1, "]$"))))

# drop NA (for window and current)
data_wide_3 <- tidyr::drop_na(data_wide_3)

# remove current date except "Open"
data_wide_3 <- dplyr::select(data_wide_3, c("Ticker", "Date", "Open_0", str_subset(names(data_wide_3), paste0("_[^", 0, "]$"))))

# sort columns nicely
data_wide_3 <- data_wide_3 %>% dplyr::select(c("Ticker", "Date"), sort(stringr::str_subset(names(.), "_[0-9]+$"), decreasing = TRUE))

# arrow::write_feather(data_wide_3, "data/data_wide_3.feather")
# data_wide_3 <- arrow::read_feather("data/data_wide_3.feather")
# data_wide_3_hash <- digest::digest(data_wide_3)


id_cols <- c("Ticker", "Date")
data_wide_3_all <- data_wide_3[, id_cols] %>% inner_join(data_wide_3_all, by = id_cols)
# arrow::write_feather(data_wide_3_all, "data/data_wide_3_all.feather")
# data_wide_3_all <- arrow::read_feather("data/data_wide_3_all.feather")
# data_wide_3_all_hash <- digest::digest(data_wide_3_all)

rm(quotes_clean)

```

Für die Analyse der Daten mit dem Ziel einen Kaufs- sowie einen Verkaufkurs zu prognostizieren, bei dem der Delta-Hedge nachgezogen werden soll, werden nachfolgend verschiedene Techniken eingesetzt. Diese sind:

- Einfache Optimierungen
- Klassifikationsverfahren (KNN):
- Neuronale Netzwerke (RNN, LTSM):
- Autogressive Modelle (GARCH)

Allen Analysen gemein ist, dass jeweils gefundene Strategien mit der Referenzstrategie verglichen wird, welche keine innertägliche Anpassung des Deltas vorsieht, sondern diese gänzlich zum Tagesschlusskurz durchführt. Eine weitere Gemeinsamkeit liegt darin, dass die verwendeten Daten keine Ausage über den Verlauf des Preises innerhalb des Tages zulassen. Inbesondere kann nicht ermittelt werden, ob zuerst eine obere oder eine untere Grenze Preisgrenze überschritten wurde. Da diese Reihenfolge aber wie in Kapitel \@ref(forschungsfrage) ausgeführt von Relevanz ist, wird für alle Analysen ein Ansatz verwendet, bei welchem zufällig bestimmt wird, ob am jeweiligen Tag zuerst eine Abwärts- oder eine Aufwärtsbewegung stattgefunden hat.[^Alternative denkbare Vorgehensweisen sind: Immer zuerst Aufwärtsbewegung, immer zuerst Abwärtsbewegung, immer die bezügl. Payoff schlechtere Reihenfolge oder immer die bezügl. Payoff bessere Variante] Auch ein mehrmaliges Erreichen der Kaufs- und Verkaufsschwelle ist innerhalb des Tages bei sehr fluktierenden Preisen in Realität denkbar. Es wären bezüglich Optimierung des Payoffs sogar sehr wünschenswerte Ereignisse. Auf die Berücksichtigung solcher Fälle wird in der Analyse allerdings verzichtet. Das Bewusstsein über deren Exsistenz ist aber bei der Interprätation der Ergebnisse dennoch inneressant, da die Payoffs der gefundenen Strategien diebezüglich als untere Grenzen des Payoffs betrachtet werden können.

```{r child="_03-1-optimization.Rmd", echo=FALSE}
```

```{r child="_03-2-knn.Rmd", echo=FALSE}
```

```{r child="_03-3-neural-networks.Rmd", echo=FALSE}
```
