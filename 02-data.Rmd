# Daten

```{r, setup_data, echo=FALSE, warning=FALSE, message=FALSE}

suppressPackageStartupMessages({
  library(digest)
  library(here)
  library(dplyr)
  library(stringr)
  library(kableExtra)
  library(purrr)
  library(tidyr)
})

source("data/download_scripts.R")
source("R/02-data.R")

# load stocks
stocks_hash <- "a2ea2a17f87576c2bf28c0e2ff80f30e"
file_stocks <- here::here(paste0("data/stocks_", stocks_hash,".rds"))
if (!file.exists(file_stocks)) {
  stocks <- download_stocks() 
  stocks_hash <- digest::digest(stocks)
  file_stocks <- here::here(paste0("data/stocks_", stocks_hash,".rds"))
  saveRDS(stocks, file_stocks)
}
stocks <- readRDS(file_stocks)

# load quotes
quotes_hash <- "6175759dd4876b820a6457a4c341e9cd"
file_quotes <- here::here(paste0("data/quotes_", quotes_hash,".rds"))
if (!file.exists(file_quotes)) {
  quotes <- download_quotes(stocks) # takes about 35mins
  quotes_hash <- digest::digest(quotes)
  file_quotes <- here::here(paste0("data/quotes_", quotes_hash,".rds"))
  saveRDS(quotes, file_quotes)
}
quotes <- readRDS(file_quotes)
```

## Bezug und Umfang

Für die Analyse werden die Aktienpreise grosser Unternehmen weltweit herangezogen. Konkret verwendet die Arbeit alle Aktienkomponenten des "iShares MSCI World UCITS ETF" [vgl. @blackrock] per 28. Februar 2020 ^[Das Startdatum dieser Arbeit.] verwendet. Dieser Exchange Traded Fund (ETF) besteht zu diesem Zeitpunkt aus `r nrow(stocks)` Komponenten, welche sich automatisiert auslesen lassen. Ferner stellt die Webseite des ETF Emittenten weitere Attribute zur Verfügung. Diese lauten am Beispiel Nesté wie folgt:

``` {r nestle-stock, echo=FALSE}
stock_nesn <- dplyr::filter(stocks, Ticker == "NESN")
knitr::kable(tibble(Attribut = names(stock_nesn), Wert = t(stock_nesn)), caption = "Attribute der Nestlé Aktie per 28. Februar 2020") %>%
  kableExtra::kable_styling(position = "center", latex_options = "HOLD_position")
```


Für alle Titel werden in einem zweiten Schritt und sofern verfügbar, die historischen Aktienkurse inkl. Höchst- und Tiefstkurs bezogen. Diese Daten stehen auf Yahoo Finance zur freien Nutzung auf täglicher Basis zur Verfügung [vgl. @yahoo_finance] und lassen sich mit entsprechedem API automatisiert abfragen. Zu beachten gilt es hierbei, dass die Yahoo Ticker für ausserhalb der USA gehandelte Titel einen Suffix für das Länderkürzel haben. Für die Analyse kommen so `r formatC(nrow(quotes), big.mark = "'")` tägliche Datenwerte für `r formatC(length(unique(quotes$Ticker)), big.mark = "'")` Titel zusammen. Für `r formatC(nrow(stocks) - length(unique(quotes$Ticker)), big.mark = "'")` Aktien können keine Werte gefunden werden. Tabelle \@ref(tab:nestle-quote) zeigt einen Beispieleintrag für die Aktie von Nesté per 14. Februar 2019. 

``` {r nestle-quote, echo=FALSE}
quote_nesn <- dplyr::filter(quotes, Ticker == "NESN.SW" & Date == as.Date("2019-04-12"))
knitr::kable(tibble(Attribut = names(quote_nesn), Wert = t(quote_nesn)), caption = "Kursinformationen der Nesté Aktie per 12. April 2019") %>%
  kableExtra::kable_styling(position = "center", latex_options = "HOLD_position")
```


## Datenaufbreitung

### Bereinigung und Normalisierung
Obwohl es sich bei den verwendeten Daten um sehr häufig verwendete Werte handelt und mit Yahoo Finance ein erfahrener Datenanbieter gewählt wurde, zeigt ein erster Blick auf die bezogenen Rohdaten gewisse Probleme und Datenmängel.

```{r, echo=FALSE}
summary(quotes)
```

Die Behebung dieser Mängel und die damit einhergehende Bereinigung erfolgt in verschiedenen Schitten:

1. Entfernen von Datenfehlern bei Corporate Actions
1. Entfernen von negativen Preisen
1. Entfernen von Einträgen mit unerwarterer Reihenfolge der vorhandenen Kennzahlen
1. Erkennen und Ausschluss offensichtlicher Tipfehler
1. Unplausible Preisbewegungen innerhalb des Tages
  

Um die Vergleichbarkeit der verschiedenen Preislevels der Kurse sicherzustellen fliessen nicht Preise, sondern die Kursveränderungen (Returns) in die Analyse mit ein. 



```{r, filter_data, echo=FALSE}
quotes <- quotes %>%
  na_wrong_corporate_actions() %>% # should be first
  na_negative_values() %>%
  na_unreasonable_measure_order() %>%
  na_typos() %>%
  na_no_intraday_moves() %>%
  group_by(Ticker) %>%
  dplyr::group_modify(~na_no_daily_changes(.)) %>%
  dplyr::group_modify(~na_too_large_daily_changes(.)) %>%
  # dplyr::group_modify(~filter_unbroken_history(.)) %>%
  ungroup()

```



### Preisadjustierung aufgrund von Corporate Actions

Die Werte in Tabelle \@ref(tab:nestle-quote) sind insofern speziell, als dass sie den Ex-Dividend Tag von Nestlé für 2019 betreffen. Das heisst es sind die Kurse des letzten Tages, bevor die Aktie ohne die für das Jahr 2019 ausgeschüttete Dividende gahandelt wurde. Die Dividende betrug für dieses Jahr CHF 2.45 [@nestle]. und wiederspiegelt sich in den Daten als Differenz des Close- und Adjusted-Preises. 



```{r, adjust_prices, echo=FALSE}
quotes <- adjust_quotes(quotes)
```





```{r, reorganize_one_line, echo=FALSE}
quotes_line <- quotes %>%
  group_by(Ticker) %>%
  dplyr::group_modify(~reorganize_to_one_line(.)) %>%
  ungroup()
```



Um Aktien mit höherem Preis nicht mehr Gewicht zu verleihen normieren wir die Preise per Schlusskurs des Vortages auf 100.

```{r, echo=FALSE}
norm_factor <- 100 / quotes_line$Adjusted_t_1
quotes_line <- mutate_at(quotes_line, c("Open", "Low", "High", "Close", "Adjusted_t", "Adjusted_t_1"),  ~norm_factor * .)

```

``` {r, remove_quanitles}
quotes_line <- na_extremes(quotes_line, col = c("Open", "Low", "High", "Close", "Adjusted_t"), tail = 0.01)

```


```{r, round_data, echo=FALSE}
quotes_line <- mutate_if(quotes_line, is.numeric, ~round(., 6)) # to avoid problems because of system accurracy
```


```{r, echo=FALSE}
# TODO: remove
# saveRDS(quotes_line, "tmp/quotes_line.rds")
```

